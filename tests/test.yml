---

- hosts: cluster
  remote_user: root
  become: True

- hosts: cluster
  remote_user: root
  become: True
  roles:
    - role: midonet.ansible-midonet-repo
      midonet_version: '5.2'
      mem: False
    - role: midonet.ansible-zookeeper
      zookeeper_hosts: '{{ groups["cluster"] }}'
    - role: midonet.ansible-cassandra
      cassandra_hosts: '{{ groups["cluster"] }}'
    - role: ansible-midonet-cluster
      zookeeper_hosts: '{{ groups["cluster"] }}'
      cassandra_hosts: '{{ groups["cluster"] }}'
      midonet_cluster_max_heap_size: "512M"
  post_tasks:
    - name: Check java and midonet-cluster processes are running
      shell: ps auxf | grep {{ item }}
      register: command_result
      failed_when: "'{{ item }}' not in command_result.stdout"
      changed_when: False
      with_items:
        - java
        - midonet-cluster
